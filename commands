#!/usr/bin/env bash
# Handles `dokku api:*` commands

DOKKU_LOG_DIR="/home/dokku/logs"
LOG_FILE="$DOKKU_LOG_DIR/dokku-api.log"

check_prerequisites() {
  # Create logs directory if it doesn't exist
  mkdir -p $DOKKU_LOG_DIR
  touch $LOG_FILE 2>/dev/null || true
  
  # Check if Flask is installed
  if ! python3 -c "import flask" &> /dev/null; then
    echo "Installing Flask..."
    /var/lib/dokku/plugins/enabled/rest-api/hooks/pre-build
  fi
}

case "$1" in
  api:start)
    check_prerequisites
    /var/lib/dokku/plugins/enabled/rest-api/bin/run-api
    echo "API started"
    ;;
  api:stop)
    pkill -f "python3.*app.py" || echo "API was not running"
    echo "API stopped"
    ;;
  api:logs)
    if [ ! -f "$LOG_FILE" ]; then
      echo "Log file does not exist. Start the API first."
    else
      tail -f "$LOG_FILE"
    fi
    ;;
  api:setup)
    echo "Setting up dokku-api..."
    /var/lib/dokku/plugins/enabled/rest-api/hooks/pre-build
    echo "Setup completed successfully"
    ;;
  *)
    echo "Available commands: api:start, api:stop, api:logs, api:setup"
    ;;
esac