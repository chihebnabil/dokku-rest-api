#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Dokku plugin directories
PLUGIN_BASE_PATH="$PLUGIN_DIR/enabled/dokku-rest-api"
PLUGIN_CONFIG_PATH="$DOKKU_LIB_ROOT/config/dokku-rest-api"
PLUGIN_DATA_PATH="$DOKKU_LIB_ROOT/data/dokku-rest-api"

# Create necessary directories
mkdir -p "$PLUGIN_CONFIG_PATH" "$PLUGIN_DATA_PATH"

# Default configuration
echo "8080" > "$PLUGIN_CONFIG_PATH/port"
echo "0.0.0.0" > "$PLUGIN_CONFIG_PATH/host"
echo "false" > "$PLUGIN_CONFIG_PATH/enabled"

# Make the main plugin file and server script executable
chmod +x "$PLUGIN_BASE_PATH/commands" "$PLUGIN_BASE_PATH/server.sh"

# Install dependencies if necessary
apt-get update && apt-get install -y jq netcat-openbsd

# Output installation message
echo "dokku-rest-api plugin installed"
echo "Run 'dokku help rest-api' for usage information"
echo "Enable the API with: dokku rest-api:enable"
echo "Start the API server with: dokku rest-api:start"